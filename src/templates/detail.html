{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ product.name }}</title>
  <link rel="stylesheet" href="{% static 'css/index.css' %}">
  <link rel="stylesheet" href="{% static 'css/product.css' %}">
  <script defer src="{% static 'js/thumbnail.js' %}"></script>
  <link rel="stylesheet" href="{% static 'css/thumbnailPhoto.css' %}"/>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body>
{% include 'elements/header.html' %}

  <div class="container__inner container__main" x-data="Product">
    <p class="main__title">головна / товар</p>
    <p class="main__title__mini">кошик</p>
    <div class="product__content">
      <div class="product__images">
        <img src="{{ product.photo.url }}" class="thumbnail" alt="">
        <div class="product__showcase">
          {% for image in product.images.all %}
          <img src="{{ image.image.url }}" class="thumbnail" alt="">
          {% endfor %}
        </div>
      </div>
      <div class="product__info">
        <div class="product__main__info">
          <div class="product__name">
            <p class="product__name__text">{{ product.name }}</p>
            <div class="product__inspect__btns">
              <a class="product__inspect__btn" href="{% url 'detail' next_product_id %}">
                <img src="{% static 'icon/arrow-left.png' %}" alt="">
              </a>
              <a class="product__inspect__btn" href="{% url 'detail' previous_product_id %}">
                <img src="{% static 'icon/arrow-right.png' %}" alt="">
              </a>
            </div>
          </div>
          <p class="product__price" > <span x-text="product.price"></span>₴</p>
        </div>
        <div class="dashed__line"></div>
        <div class="product__desc">
          <p class="product__desc__text">
          {{ product.description }}
          </p>
        </div>
        <div class="dashed__line"></div>
        <div class="product__info__size">
          {% regroup product.options.all|dictsort:"group.id" by group.id as grouped_options %}
          {% for group in grouped_options %}
          {% for option in group.list %}
          <div class="product__info__size__container" :class="{ 'active':  isOptionSelected({{ option.id }}) }"  @click="toggleOption({{ group.grouper }},{{ option.id }})">
              {% if option.color %}
                  <div class="color" style="background-color: {{ option.get_color }}; width: 20px; height: 20px; display: inline-block;"></div>
              {% endif %}

            <p class="product__info__size__text" :class="{ 'active':  isOptionSelected({{ option.id }}) }">{{ option.value|safe }}
              {% if option.additional_price %}
                  - {{ option.additional_price }}₴
              {% endif %}
            </p>
          </div>
          {% endfor %}
         {% endfor %}
        </div>
        <div class="product__quantity__container">
          <button class="product__addtocart__btn" @click="addBasket" :class="{ 'active': isBuyButtonActive}">
            <img src="{% static 'icon/shopping-cart.png' %}" alt="">
            <p class="product__cart__text" x-text="buyButtonText"></p>
          </button>
          <div class="product__quantity__btns">
            <button class="quantity__btn">
              <img src="{% static 'icon/minus.png' %}" alt="" @click.stop="editQuantity('minus')">
            </button>
            <p class="product__quantity" x-text="product.productQuantity"></p>
            <button class="quantity__btn">
              <img src="{% static 'icon/plus.png' %}" alt="" @click.stop="editQuantity('plus')">
            </button>
          </div>
        </div>
        <div class="product__more__container">
          <a target="_blank" class="product__more__link" href="https://www.instagram.com/warrior_spir1t/profilecard/?igsh=YWV4dTl2MHdzY28w">
            <p class="product__more__about">Детальніше о товару</p>
            <img src="{% static 'icon/instagram.png' %}" alt="">
          </a>
        </div>
      </div>
    </div>

  </div>

  <div class="container__inner also__buy__container">
    <div class="main__wrapper__hoodies">
      <div class="hoodies__upper">
        <p class="hoodies__upper__text">З цим купують</p>
        <div class="hoodies__dashed__line"></div>
      </div>



      <div class="hoodies__cards">
        {% for product in top_products %}
        {% include 'elements/product.html' %}
      {% endfor %}


      </div>
    </div>
  </div>
    <div id="modal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="modal-image">
        <div id="caption"></div>
    </div>

    <script>
      document.addEventListener("alpine:init", () => {
        Alpine.data("Product", () => ({
          basket: Alpine.$persist([]).as("basket"),
          buyButtonText:"У кошик",
          isBuyButtonActive: false,
          product: {
            id: "{{ product.id }}",
            name: "{{ product.name }}",
            photo: "{{ product.photo.url }}",
            basePrice: {{ product.price }},
            price: {{ product.price }},
            productQuantity: 1,
            activeOptions: [],
          },
          options: [],
          init() {
            // Load options from the template using regroup
          this.options = [
              {% for option in product.options.all %}
                {
                  id: {{ option.id }},
                  group_id: {{ option.group.id }},
                  group_name: "{{ option.group.name|escapejs }}",
                  value: "{{ option.value|escapejs }}",
                  additional_price: {{ option.additional_price }},
                  is_required: {{ option.group.is_required|yesno:'true,false' }},
                  color: "{{ option.get_color }}",
                },
              {% endfor %}
            ];

            // Automatically select cheapest options for required groups
            const requiredGroups = this.options.filter(option => option.is_required);
            const cheapestOptions = requiredGroups.reduce((result, option) => {
              if (!result[option.group_id] || option.additional_price < result[option.group_id].additional_price) {
                result[option.group_id] = option;
              }
              return result;
            }, {});

            // Set default selected options
            Object.values(cheapestOptions).forEach(option => {
              this.product.activeOptions.push(option);
            });

            // Update total price
            this.updatePrice();
          },
          toggleOption(group_id, option_id) {
            // Deselect previous option from the same group
            this.product.activeOptions = this.product.activeOptions.filter(
              activeOption => activeOption.group_id !== group_id
            );

            // Add the new option
            this.product.activeOptions.push(this.options.find(item => item.id === option_id));

            // Update total price
            this.updatePrice();
          },
            editQuantity(action){
              if (action === "plus") {
                this.product.productQuantity++;
              } else if (
                action === "minus" &&
                this.product.productQuantity > 1
              ) {
                this.product.productQuantity--;
            }
          },
          updatePrice() {
            const additionalPrice = this.product.activeOptions.reduce(
              (total, option) => total + option.additional_price,
              0
            );
            this.product.price = this.product.basePrice + additionalPrice;
          },
           generateRandomString() {
              const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
              let result = '';
              const length = 10; // довжина рядка

              for (let i = 0; i < length; i++) {
                  result += characters.charAt(Math.floor(Math.random() * characters.length));
              }

              return result;
          },
          addBasket() {
            this.basket.push({
              ...this.product,
              "itemID": this.generateRandomString()
            });
            this.buyButtonText = "Додано";
            this.isBuyButtonActive = true;
            setTimeout(() => {
              this.buyButtonText = "У кошик";
              this.isBuyButtonActive = false;
            }, 2000);
          },
          isOptionSelected(option_id) {
            return this.product.activeOptions.some(activeOption => activeOption.id === option_id);
          },
        }));
      });
    </script>

</body>


</html>